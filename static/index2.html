<!DOCTYPE html>
<!--suppress ES6ModulesDependencies -->
<html>

<head>
    <title>Deep Snake</title>
    <link rel="stylesheet" href="css/main.css">
</head>

<body>

<div class="container">
    <div id="ai" class="box left">
        <span>this is our AI being trained.</span>
    </div>
    <div id="weights" class="box left">
        <span>OUTPUT.</span>
    </div>
    <div id="stats" class="box left">
        <span>learning PROGRESS.</span>
    </div>
</div>


<script src="https://d3js.org/d3.v4.js"></script>
<script src="js/convnet-min.js"></script>
<script src="js/deepsnake.js"></script>
<script>

    const interval = 100;
    const palette = d3.schemeCategory10;
    const orange = palette[1];
    const green = palette[2];
    const red = palette[3];

    let trainee = new deepsnake.Brain2();
    let player =  new deepsnake.Brain2();

    (function trainer(brain) {
        let game = new deepsnake.Game();

        function loop() {
            let decision = game.hint();
            game.tick(decision);
            let point = game.universe.snake.head();
            let focus = [point.x , point.y];
            brain.decide(game.state());
            brain.reward(focus);
            setTimeout(loop, 0);
        }

        loop();
    })(trainee);

    (function ai(brain) {
        let game = new deepsnake.Game();
        let grid = new deepsnake.Grid("#ai").color(red, green);
        let map =  new deepsnake.Map("#weights");

        function loop() {
            let decision = game.hint();
            game.tick(decision, function draw(cells) {
                grid.draw(cells);
                let weights = brain.decide(game.state());
                map.draw(weights);
            });
            setTimeout(loop, interval);
        }

        loop();
    })(player);

    (function cloneExperience() {
        player.cloneFrom(trainee);
        setTimeout(cloneExperience, 5000);
    })();

    (function stats(brain) {
        let chart = new deepsnake.Chart("#stats", "loose", [240, 240], 50, 1);
        let color = d3.scaleLinear().domain([0.15, 0.5]).interpolate(d3.interpolateHcl).range([green, orange, red]);

        function loop() {
            chart.push(brain.loss);
            chart.color(color(chart.avg()));
            setTimeout(loop, interval * 5);
        }

        loop();
    })(trainee);


</script>


</body>

</html>
